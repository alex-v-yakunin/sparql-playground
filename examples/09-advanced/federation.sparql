# Федеративные запросы (SPARQL Federation)
#
# Интеграция данных из внешнего SPARQL endpoint (DBpedia).
#
# Ожидаемый результат: 6 технологий с описаниями из DBpedia (если DBpedia доступен)
# Примечание: Требует интернет-соединения и доступности DBpedia.
#             Часто возвращает 0 результатов из-за недоступности DBpedia.
#             Это нормально для федеративных запросов - внешние сервисы могут быть недоступны.
# Время выполнения: 2-5 секунд (если DBpedia отвечает), мгновенно (если недоступен)

PREFIX : <http://example.org/adr#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX dbo: <http://dbpedia.org/ontology/>
PREFIX dbr: <http://dbpedia.org/resource/>

SELECT ?technology ?adrCount ?dbpediaDescription
WHERE {
    {
        SELECT ?technology (COUNT(?adr) AS ?adrCount)  # Локальные данные: подсчёт ADR
        WHERE {
            ?adr :decidesTechnology ?tech .   # Найти ADR с технологией
            ?tech rdfs:label ?technology .    # Название технологии
        }
        GROUP BY ?technology               # Группировать по технологии
    }
    
    VALUES (?technology ?dbpediaResource) {  # Маппинг локальных названий на DBpedia URI
        ("Apache Kafka" dbr:Apache_Kafka)
        ("PostgreSQL"  dbr:PostgreSQL)
        ("Redis"       dbr:Redis)
        ("MongoDB"     dbr:MongoDB)
        ("Kubernetes"  dbr:Kubernetes)
        ("Docker"      <http://dbpedia.org/resource/Docker_(software)>)
    }
    
    SERVICE <https://dbpedia.org/sparql> {   # Запрос к внешнему endpoint
        ?dbpediaResource dbo:abstract ?desc . # Получить описание из DBpedia
        FILTER(LANG(?desc) = "en")            # Только английские описания
    }
    
    BIND(STR(?desc) AS ?dbpediaDescription)  # Преобразовать в строку
}
ORDER BY DESC(?adrCount)                     # Сортировать по популярности

# Пояснение:
# SPARQL Federation позволяет запрашивать удалённые SPARQL endpoints.
# 
# SERVICE <URL> { ... } отправляет подзапрос внешнему серверу.
# VALUES создаёт маппинг между нашими технологиями и DBpedia URI.
# FILTER(LANG(?desc) = "en") выбирает описания на английском.
# 
# Это избавляет от необходимости ETL для интеграции внешних данных!
# Данные запрашиваются в реальном времени при выполнении запроса.
# 
# ВАЖНО: DBpedia часто недоступен или перегружен, поэтому запрос может вернуть
# пустой результат. Это нормальное поведение для федеративных запросов - они
# зависят от доступности внешних сервисов.
# 
# Чтобы проверить локальную часть (без DBpedia), удалите блок SERVICE и
# оставьте только VALUES - вы увидите 6 технологий с их количеством ADR.
# 
# В SQL: потребовалась бы отдельная таблица с ETL-процессом.
# В Property Graph: загрузка внешних данных в граф.
# В SPARQL: встроенная федерация - мощь семантического веба!
