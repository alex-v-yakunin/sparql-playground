# Федеративные запросы (SPARQL Federation)
#
# Интеграция данных из внешнего SPARQL endpoint (DBpedia).
#
# Ожидаемый результат: 6 технологий (всегда), описания из DBpedia (если доступен)
# Примечание: SERVICE блок обернут в OPTIONAL, поэтому запрос работает всегда.
#             Если DBpedia доступен - вы увидите описания.
#             Если недоступен - просто список технологий с количеством ADR.
# Время выполнения: < 1 секунда (локально), +2-5 секунд (если DBpedia отвечает)

PREFIX : <http://example.org/adr#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX dbo: <http://dbpedia.org/ontology/>
PREFIX dbr: <http://dbpedia.org/resource/>

SELECT ?technology ?adrCount ?dbpediaDescription
WHERE {
    {
        SELECT ?technology (COUNT(?adr) AS ?adrCount)  # Локальные данные: подсчёт ADR
        WHERE {
            ?adr :decidesTechnology ?tech .   # Найти ADR с технологией
            ?tech rdfs:label ?technology .    # Название технологии
        }
        GROUP BY ?technology               # Группировать по технологии
    }
    
    VALUES (?technology ?dbpediaResource) {  # Маппинг локальных названий на DBpedia URI
        ("Apache Kafka" dbr:Apache_Kafka)
        ("PostgreSQL"  dbr:PostgreSQL)
        ("Redis"       dbr:Redis)
        ("MongoDB"     dbr:MongoDB)
        ("Kubernetes"  dbr:Kubernetes)
        ("Docker"      <http://dbpedia.org/resource/Docker_(software)>)
    }
    
    OPTIONAL {                               # OPTIONAL: работает даже если DBpedia недоступен
        SERVICE <https://dbpedia.org/sparql> {   # Запрос к внешнему endpoint
            ?dbpediaResource dbo:abstract ?desc . # Получить описание из DBpedia
            FILTER(LANG(?desc) = "en")            # Только английские описания
        }
        BIND(STR(?desc) AS ?dbpediaDescription)  # Преобразовать в строку
    }
}
ORDER BY DESC(?adrCount)                     # Сортировать по популярности

# Пояснение:
# SPARQL Federation позволяет запрашивать удалённые SPARQL endpoints.
# 
# SERVICE <URL> { ... } отправляет подзапрос внешнему серверу.
# OPTIONAL { SERVICE ... } делает запрос устойчивым к недоступности внешних сервисов.
# VALUES создаёт маппинг между нашими технологиями и DBpedia URI.
# FILTER(LANG(?desc) = "en") выбирает описания на английском.
# 
# Это избавляет от необходимости ETL для интеграции внешних данных!
# Данные запрашиваются в реальном времени при выполнении запроса.
# 
# ВАЖНО: Обернув SERVICE в OPTIONAL, мы делаем запрос устойчивым:
# - Если DBpedia доступен → получаем описания (dbpediaDescription заполнен)
# - Если недоступен → все равно получаем локальные данные (dbpediaDescription пустой)
# 
# Без OPTIONAL, недоступность DBpedia привела бы к пустому результату всего запроса.
# С OPTIONAL запрос ВСЕГДА возвращает локальные данные (6 технологий).
# 
# В SQL: потребовалась бы отдельная таблица с ETL-процессом.
# В Property Graph: загрузка внешних данных в граф.
# В SPARQL: встроенная федерация - мощь семантического веба!
