# Federated Queries (SPARQL Federation)
#
# Integration of data from external SPARQL endpoint (DBpedia).
#
# Expected result: 6 technologies (always), descriptions from DBpedia (if available)
# Note: SERVICE block wrapped in OPTIONAL, so query always works.
#       If DBpedia available - you'll see descriptions.
#       If unavailable - just technology list with ADR count.
# Execution time: < 1 second (local), +2-5 seconds (if DBpedia responds)

PREFIX : <http://example.org/adr#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX dbo: <http://dbpedia.org/ontology/>
PREFIX dbr: <http://dbpedia.org/resource/>

SELECT ?technology ?adrCount ?dbpediaDescription
WHERE {
    {
        SELECT ?technology (COUNT(?adr) AS ?adrCount)  # Local data: count ADRs
        WHERE {
            ?adr :decidesTechnology ?tech .   # Find ADRs with technology
            ?tech rdfs:label ?technology .    # Technology label
        }
        GROUP BY ?technology               # Group by technology
    }
    
    VALUES (?technology ?dbpediaResource) {  # Mapping local names to DBpedia URIs
        ("Apache Kafka" dbr:Apache_Kafka)
        ("PostgreSQL"  dbr:PostgreSQL)
        ("Redis"       dbr:Redis)
        ("MongoDB"     dbr:MongoDB)
        ("Kubernetes"  dbr:Kubernetes)
        ("Docker"      <http://dbpedia.org/resource/Docker_(software)>)
    }
    
    OPTIONAL {                               # OPTIONAL: works even if DBpedia unavailable
        SERVICE <https://dbpedia.org/sparql> {   # Query to external endpoint
            ?dbpediaResource dbo:abstract ?desc . # Get description from DBpedia
            FILTER(LANG(?desc) = "en")            # Only English descriptions
        }
        BIND(STR(?desc) AS ?dbpediaDescription)  # Convert to string
    }
}
ORDER BY DESC(?adrCount)                     # Sort by popularity

# Explanation:
# SPARQL Federation allows querying remote SPARQL endpoints.
# 
# SERVICE <URL> { ... } sends subquery to external server.
# OPTIONAL { SERVICE ... } makes query resilient to external service unavailability.
# VALUES creates mapping between our technologies and DBpedia URIs.
# FILTER(LANG(?desc) = "en") selects English descriptions.
# 
# This eliminates need for ETL to integrate external data!
# Data is queried in real-time when executing the query.
# 
# IMPORTANT: Wrapping SERVICE in OPTIONAL makes query resilient:
# - If DBpedia available → get descriptions (dbpediaDescription filled)
# - If unavailable → still get local data (dbpediaDescription empty)
# 
# Without OPTIONAL, DBpedia unavailability would result in empty result for entire query.
# With OPTIONAL query ALWAYS returns local data (6 technologies).
# 
# In SQL: would require separate table with ETL process.
# In Property Graph: loading external data into graph.
# In SPARQL: built-in federation - power of semantic web!
