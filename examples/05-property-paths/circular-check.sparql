# Проверка циклических зависимостей
#
# Property paths позволяют легко обнаружить циклы в графе
# Если технология зависит сама от себя транзитивно - это цикл!
#
# В SQL: сложная рекурсия с отслеживанием посещённых узлов
# В SPARQL: простой паттерн
#
# Ожидаемый результат: Технологии с циклическими зависимостями
# - ServiceMesh → Kubernetes → Docker → ServiceMesh (demo cycle)
# В production данных циклов быть не должно (архитектурный антипаттерн)
# Время: < 1 секунда

PREFIX : <http://example.org/adr#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?tech ?techLabel ?cyclePath
WHERE {
    # Технология транзитивно зависит от самой себя = цикл!
    ?tech :dependsOn+ ?tech .
    ?tech rdfs:label ?techLabel .
    
    # Попытаться построить путь цикла
    OPTIONAL {
        {
            SELECT ?tech (GROUP_CONCAT(?middleLabel; separator=" → ") AS ?cyclePath)
            WHERE {
                ?tech :dependsOn+ ?middle .
                ?middle :dependsOn+ ?tech .
                ?middle rdfs:label ?middleLabel .
            }
            GROUP BY ?tech
        }
    }
}
